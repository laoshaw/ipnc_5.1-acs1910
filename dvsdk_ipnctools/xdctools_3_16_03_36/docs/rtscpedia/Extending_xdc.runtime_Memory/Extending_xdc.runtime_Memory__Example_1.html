<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en" dir="ltr">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
				<link rel="shortcut icon" href="/favicon.ico" />
		<link rel="search" type="application/opensearchdescription+xml" href="mediawiki-tip/opensearch_desc.php" title="RTSC-Pedia (English)" />
		<title>Extending xdc.runtime Memory/Example 1 - Offline Version</title>
		<style type="text/css" media="screen, projection">/*<![CDATA[*/
			@import "../common/skins/common/shared.css";
			@import "../common/skins/monobook/main.css";
		/*]]>*/</style>
		<link rel="stylesheet" type="text/css" media="print" href="../common/skins/common/commonPrint.css" />
		<!--[if lt IE 5.5000]><style type="text/css">@import "../common/skins/monobook/IE50Fixes.css";</style><![endif]-->
		<!--[if IE 5.5000]><style type="text/css">@import "../common/skins/monobook/IE55Fixes.css";</style><![endif]-->
		<!--[if IE 6]><style type="text/css">@import "../common/skins/monobook/IE60Fixes.css";</style><![endif]-->
		<!--[if IE 7]><style type="text/css">@import "../common/skins/monobook/IE70Fixes.css";</style><![endif]-->
		<!--[if lt IE 7]><script type="text/javascript" src="../common/skins/common/IEFixes.js?97"></script>
		<meta http-equiv="imagetoolbar" content="no" /><![endif]-->
		
		<script type= "text/javascript">/*<![CDATA[*/
var skin = "monobook";
var stylepath = "../common/skins";
var wgArticlePath = "/docs-tip/$1";
var wgScriptPath = "mediawiki-tip";
var wgScript = "mediawiki-tip/index.php";
var wgServer = "http://rtsc.eclipse.org";
var wgCanonicalNamespace = "Special";
var wgCanonicalSpecialPageName = "Offline";
var wgNamespaceNumber = -1;
var wgPageName = "Special:Offline";
var wgTitle = "Offline";
var wgAction = "view";
var wgRestrictionEdit = [];
var wgRestrictionMove = [];
var wgArticleId = 0;
var wgIsArticle = true;
var wgUserName = null;
var wgUserGroups = null;
var wgUserLanguage = "en";
var wgContentLanguage = "en";
var wgBreakFrames = false;
var wgCurRevisionId = 0;
/*]]>*/</script>
                
		<script type="text/javascript" src="../common/skins/common/wikibits.js?97"><!-- wikibits js --></script>
		<script type="text/javascript" src="mediawiki-tip/index.php?title=-&amp;action=raw&amp;gen=js&amp;useskin=monobook"><!-- site js --></script>
		<style type="text/css">/*<![CDATA[*/
@import "mediawiki-tip/index.php?title=MediaWiki:Common.css&usemsgcache=yes&action=raw&ctype=text/css&smaxage=18000";
@import "mediawiki-tip/index.php?title=MediaWiki:Monobook.css&usemsgcache=yes&action=raw&ctype=text/css&smaxage=18000";
@import "mediawiki-tip/index.php?title=-&action=raw&gen=css&maxage=18000";
/*]]>*/</style>
		<!-- Head Scripts -->
<link rel="stylesheet" type="text/css" href="../common/extensions/rtsc/ViewStyle.css" /><link rel="stylesheet" type="text/css" href="../common/extensions/rtsc/MainStyle.css" />
	</head>
<body  class="mediawiki ns--1 ltr page-Special_Offline">
	<div id="globalWrapper" align="center">
		<div id="column-content">
	<div id="content">
		<a name="top" id="top"></a>
				<h1 class="firstHeading"></h1>
		<div id="bodyContent">
			<h3 id="siteSub">From RTSC-Pedia</h3>
			<div id="contentSub"></div>
									<div id="jump-to-nav">Jump to: <a href="#column-one">navigation</a>, <a href="#searchInput">search</a></div>			<!-- start content --><div id="revInfo">revision tip</div><span id="printInfo">&#151;&#151;&nbsp;LANDSCAPE orientation</span><table width="100%"><tr><td class="lights"><img src="../common/extensions/rtsc/images/yellow_light.png" /></td><td class="offline">[<a href="/mediawiki-tip/index.php?title=Extending xdc.runtime Memory/Example 1&amp;printable=yes" title="just this page in black-and-white, ready for printing in landscape orientation">printable version</a>]&nbsp;&nbsp;</td><td class="offlineDate">offline version generated on 02-Oct-2009 22:10 UTC</td><td class="arrows"><a href="Extending_xdc.runtime_Memory.html#TOC" title="Extending xdc.runtime Memory"><img src="../common/extensions/rtsc/images/Arrow_up.png" /></a></td></tr></table><p id="title">Extending xdc.runtime Memory/Example 1</p><p id="subtitle">A heap that tracks <tt>Memory</tt> allocations</p>
<p></p>
<table id="toc" class="toc" summary="Contents"><tr><td><div id="toctitle"><h2>Contents</h2></div>
<ul>
<li class="toclevel-1"><a href="#A_Heap_Monitor"><span class="tocnumber">1</span> <span class="toctext">A Heap Monitor</span></a></li>
<li class="toclevel-1"><a href="#How_to_Use_the_Check_Heap_Monitor"><span class="tocnumber">2</span> <span class="toctext">How to Use the Check Heap Monitor</span></a></li>
<li class="toclevel-1"><a href="#How_to_Implement_the_Check_Heap_Monitor"><span class="tocnumber">3</span> <span class="toctext">How to Implement the Check Heap Monitor</span></a>
<ul>
<li class="toclevel-2"><a href="#The_Check_Module"><span class="tocnumber">3.1</span> <span class="toctext">The Check Module</span></a></li>
<li class="toclevel-2"><a href="#The_Package_Files"><span class="tocnumber">3.2</span> <span class="toctext">The Package Files</span></a></li>
</ul>
</li>
<li class="toclevel-1"><a href="#Summary_and_Extensions"><span class="tocnumber">4</span> <span class="toctext">Summary and Extensions</span></a></li>
</ul>
</li>
</ul>
</td></tr></table><script type="text/javascript"> if (window.showTocToggle) { var tocShowText = "show"; var tocHideText = "hide"; showTocToggle(); } </script>
<a name="A_Heap_Monitor"></a><h2> <span class="mw-headline">A Heap Monitor</span></h2>
<p>In this section we develop a simple <tt>IHeap</tt> that illustrates how to create custom heaps.  Suppose, for example that you want to monitor your application's use of memory and look for memory leaks or buffer overflows.
</p>
<a name="How_to_Use_the_Check_Heap_Monitor"></a><h2> <span class="mw-headline">How to Use the <tt>Check</tt> Heap Monitor</span></h2>
<p>We begin by showing how the <tt>Check</tt> module can be configured atop an existing <tt>IHeap</tt> to monitor allocated memory.  In the example below we show a simple client application that uses the <tt>Memory</tt> module to allocate a free memory.  This example, illustrates that adding the <tt>Check</tt> only requires a very small change to an existing configuration file and no change to existing code.
</p>
<table>

<tr valign="top">
<td><table cellpadding="0" cellspacing="0" class="codex"><tr><td class="codexLab"></td><td class="codexName"><tt>app.c</tt></td></tr><tr class="codex"><td class="codexLab"><tt class="codexLab">&nbsp;<br />&nbsp;<br />&nbsp;<br />&nbsp;<br />&nbsp;<br />&nbsp;<br />&nbsp;<br />&nbsp;<br />&nbsp;<br />&nbsp;<br />&nbsp;<br />&nbsp;<br />&nbsp;<br />&nbsp;<br />&nbsp;<br />&nbsp;<br />&nbsp;<br />&nbsp;<br />&nbsp;<br />&nbsp;<br />&nbsp;<br />&nbsp;<br />&nbsp;<br />&nbsp;<br />&nbsp;<br />&nbsp;<br /></tt></td><td class="codexBody"><pre class="c"><span class="re1">#include</span> <span class="re2">&lt;xdc/std.h&gt;</span>
&nbsp;
<span class="re1">#include</span> <span class="re2">&lt;xdc/runtime/Error.h&gt;</span>
<span class="re1">#include</span> <span class="re2">&lt;xdc/runtime/Memory.h&gt;</span>
<span class="re1">#include</span> <span class="re2">&lt;xdc/runtime/LoggerBuf.h&gt;</span>
&nbsp;
<span class="coMULTI">/* ======== main ======== */</span>
<span class="kw2">Int</span> main<span class="br0">&#40;</span><span class="kw2">Int</span> argc, <span class="kw2">String</span> argv<span class="br0">&#91;</span><span class="br0">&#93;</span><span class="br0">&#41;</span>
<span class="br0">&#123;</span>
    <span class="kw2">Int</span> i;
    LoggerBuf_Handle logger;
    Error_Block eb;
&nbsp;
    Error_init<span class="br0">&#40;</span>&amp;eb<span class="br0">&#41;</span>;
&nbsp;
    <span class="kw1">for</span> <span class="br0">&#40;</span>i = <span class="nu0">0</span>; i &lt; <span class="nu0">10</span>; i++<span class="br0">&#41;</span> <span class="br0">&#123;</span>
        logger = LoggerBuf_create<span class="br0">&#40;</span><span class="kw2">NULL</span>, &amp;eb<span class="br0">&#41;</span>;
        <span class="kw1">if</span> <span class="br0">&#40;</span>logger&nbsp;!= <span class="kw2">NULL</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
            <span class="kw1">if</span> <span class="br0">&#40;</span>i<span class="br0">&#41;</span> <span class="br0">&#123;</span> <span class="coMULTI">/* create a memory leak! */</span>
                LoggerBuf_delete<span class="br0">&#40;</span>&amp;logger<span class="br0">&#41;</span>;
            <span class="br0">&#125;</span>
        <span class="br0">&#125;</span>
    <span class="br0">&#125;</span>
&nbsp;
    <span class="kw1">return</span> <span class="br0">&#40;</span><span class="nu0">0</span><span class="br0">&#41;</span>;
<span class="br0">&#125;</span></pre></td></tr></table>
</td><td><table cellpadding="0" cellspacing="0" class="codex"><tr><td class="codexLab"></td><td class="codexName"><tt>app.cfg</tt></td></tr><tr class="codex"><td class="codexLab"><tt class="codexLab">&nbsp;<br />&nbsp;<br />&nbsp;<br />&nbsp;<br />&nbsp;<br />&nbsp;<br />&nbsp;<br />&nbsp;<br />&nbsp;<br />&nbsp;<br />&nbsp;<br />&nbsp;<br />&nbsp;<br /></tt></td><td class="codexBody"><pre class="xdcscript"><span class="kw1">var</span> Error = <span class="re1">xdc.useModule</span><span class="br0">&#40;</span><span class="st0">&quot;xdc.runtime.Error&quot;</span><span class="br0">&#41;</span>;
<span class="kw1">var</span> Memory = <span class="re1">xdc.useModule</span><span class="br0">&#40;</span><span class="st0">&quot;xdc.runtime.Memory&quot;</span><span class="br0">&#41;</span>;
<span class="kw1">var</span> LoggerBuf = <span class="re1">xdc.useModule</span><span class="br0">&#40;</span><span class="st0">&quot;xdc.runtime.LoggerBuf&quot;</span><span class="br0">&#41;</span>;
&nbsp;
<span class="kw1">var</span> Check = <span class="re1">xdc.useModule</span><span class="br0">&#40;</span><span class="st0">&quot;examples.runtime.heap.Check&quot;</span><span class="br0">&#41;</span>;
<span class="kw1">var</span> HeapStd = <span class="re1">xdc.useModule</span><span class="br0">&#40;</span><span class="st0">&quot;xdc.runtime.HeapStd&quot;</span><span class="br0">&#41;</span>;
&nbsp;
<span class="coMULTI">/* make Check the heap for all allocations */</span>
Memory.defaultHeapInstance = Check.create<span class="br0">&#40;</span><span class="br0">&#41;</span>;
&nbsp;
<span class="coMULTI">/* give Check a heap that can allocate real memory */</span>
Check.common$.instanceHeap = 
    HeapStd.create<span class="br0">&#40;</span><span class="br0">&#123;</span>size: <span class="nu0">4096</span><span class="br0">&#125;</span><span class="br0">&#41;</span>;</pre></td></tr></table>
</td></tr></table>
<p>The output of this example is shown below.
</p>
<table cellpadding="0" cellspacing="0" class="codex"><tr class="codex"><td class="codexLab"><tt class="codexLab">&nbsp;<br /></tt></td><td class="codexBody"><pre>examples.runtime.heap.Check: line 100: memory leak: 2 more allocations than frees (heap = @08050688)</pre></td></tr></table>
<a name="How_to_Implement_the_Check_Heap_Monitor"></a><h2> <span class="mw-headline">How to Implement the <tt>Check</tt> Heap Monitor</span></h2>
<p>In this section we look under the covers to see how <tt>Check</tt> is implemented.  We begin by looking at the implementation of the <tt>Check</tt> module and end by showing the other files necessary to deliver this module within a package. 
</p>
<a name="The_Check_Module"></a><h3> <span class="mw-headline">The <tt>Check</tt> Module</span></h3>
<p>All heap managers must implement the <tt><a href="../../cdoc/xdc/runtime/IHeap.html" class="cdoc"><tt>xdc.runtime.IHeap</tt></a></tt> interface.  In addition, because heap instances are most often created during configuration, heap managers should also support configuration-time instance creation.  Fortunately, both of these requirements are easily meet.  The <tt>Check.xdc</tt> file declares that the <tt>Check</tt> module inherits <tt>xdc.runtime.IHeap</tt> and includes an <tt>internal</tt> section that defines the instance object's state structure.  This definition, together with the initialization function <tt><a href="../XDCscript_-_Instance-Body.instance%24static%24init/XDCscript_-_Instance-Body.instance%24static%24init.html" title="XDCscript - Instance-Body.instance$static$init">instance$static$init()</a></tt>, defined in <tt>Check.xs</tt>, is sufficient to enable static instances to be created during configuration.
</p><p>The <tt>Check</tt> module works by simply maintaining the number of allocations minus the number of frees for each heap instance.  If this number is non-zero at the end of the application, a memory leak has occurred.  In order to get control at the end of the application, <tt>Check</tt> uses the <tt><a href="../../cdoc/xdc/runtime/System.html#atexit" class="cdoc"><tt>System_atexit()</tt></a></tt> method to install the <tt>doCheck</tt> function, defined in <tt>Check.c</tt>, as a function to be executed when the application exits.  But, in order to call <tt>System_atexit()</tt>, the <tt>Check.xdc</tt> module specification uses the <tt>@ModuleStartup</tt> attribute to declare that it has a "startup" method that must be called prior to the application's <tt>main()</tt> entry-point.  This startup method, named <tt>Check_Module_startup</tt>, is defined in <tt>Check.c</tt>.
</p>
<table cellpadding="0" cellspacing="0" class="codex"><tr><td class="codexLab"></td><td class="codexName"><tt>Check.xdc (Check Module's Specification)</tt></td></tr><tr class="codex"><td class="codexLab"><tt class="codexLab">&nbsp;<br />&nbsp;<br />&nbsp;<br />&nbsp;<br />&nbsp;<br />&nbsp;<br />&nbsp;<br />&nbsp;<br />&nbsp;<br />&nbsp;<br />&nbsp;<br />&nbsp;<br />&nbsp;<br />&nbsp;<br />&nbsp;<br />&nbsp;<br />&nbsp;<br />&nbsp;<br />&nbsp;<br />&nbsp;<br />&nbsp;<br /></tt></td><td class="codexBody"><pre class="xdcspec"><span class="kw1">import</span> xdc.runtime.Error;
&nbsp;
<span class="xdoc">/*!
 *  ======== Check ========
 *  Check number of allocations and frees
 */</span>
<span class="re1">@ModuleStartup</span>  <span class="coMULTI">/* this module has a startup fxn to be called prior to main */</span>
<span class="kw1">module</span> Check <span class="kw1">inherits</span> xdc.runtime.IHeap
<span class="br0">&#123;</span>
    <span class="xdoc">/*!
     *  ======== E_memory ========
     */</span>
    <span class="kw1">config</span> Error.Id E_memory = <span class="br0">&#123;</span>
        msg: <span class="st0">&quot;memory leak:&nbsp;%d more allocations than frees (heap =&nbsp;%p)&quot;</span>
    <span class="br0">&#125;</span>;
&nbsp;
<span class="kw1">internal</span>:
    <span class="kw1">struct</span> Instance_State <span class="br0">&#123;</span>
        <span class="kw2">Int</span> count;
    <span class="br0">&#125;</span>;
<span class="br0">&#125;</span></pre></td></tr></table>
<p>The implementation of this specification is shown below.
</p>
<table>

<tr valign="top">
<td><table cellpadding="0" cellspacing="0" class="codex"><tr><td class="codexLab"></td><td class="codexName"><tt>Check.c (initialization code)</tt></td></tr><tr class="codex"><td class="codexLab"><tt class="codexLab">&nbsp;<br />&nbsp;<br />&nbsp;<br />&nbsp;<br />&nbsp;<br />&nbsp;<br />&nbsp;<br />&nbsp;<br />&nbsp;<br />&nbsp;<br />&nbsp;<br />&nbsp;<br />&nbsp;<br />&nbsp;<br />&nbsp;<br />&nbsp;<br />&nbsp;<br />&nbsp;<br />&nbsp;<br />&nbsp;<br />&nbsp;<br />&nbsp;<br />&nbsp;<br />&nbsp;<br />&nbsp;<br />&nbsp;<br />&nbsp;<br /></tt></td><td class="codexBody"><pre class="c"><span class="re1">#include</span> <span class="re2">&lt;xdc/std.h&gt;</span>
&nbsp;
<span class="re1">#include</span> <span class="re2">&lt;xdc/runtime/Startup.h&gt;</span>
<span class="re1">#include</span> <span class="re2">&lt;xdc/runtime/System.h&gt;</span>
&nbsp;
<span class="re1">#include</span> <span class="st0">&quot;package/internal/Check.xdc.h&quot;</span>
&nbsp;
<span class="kw1">static</span> <span class="kw2">Void</span> doCheck<span class="br0">&#40;</span><span class="kw2">Void</span><span class="br0">&#41;</span>; <span class="coMULTI">/*checks all instances */</span>
&nbsp;
<span class="coMULTI">/* ======== Check_Instance_init ======== */</span>
<span class="kw2">Void</span> Check_Instance_init<span class="br0">&#40;</span>Check_Object *obj, 
    const Check_Params *params<span class="br0">&#41;</span>
<span class="br0">&#123;</span>
    obj-&gt;count = <span class="nu0">0</span>;
<span class="br0">&#125;</span>
&nbsp;
<span class="coMULTI">/* ======== Check_Module_startup ======== */</span>
<span class="kw2">Int</span> Check_Module_startup<span class="br0">&#40;</span><span class="kw2">Int</span> state<span class="br0">&#41;</span>
<span class="br0">&#123;</span>
    <span class="kw1">if</span> <span class="br0">&#40;</span>!Startup_rtsDone<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
        <span class="kw1">return</span> <span class="br0">&#40;</span>Startup_NOTDONE<span class="br0">&#41;</span>;
    <span class="br0">&#125;</span>
&nbsp;
    System_atexit<span class="br0">&#40;</span>doCheck<span class="br0">&#41;</span>;
&nbsp;
    <span class="kw1">return</span> <span class="br0">&#40;</span>Startup_DONE<span class="br0">&#41;</span>;
<span class="br0">&#125;</span></pre></td></tr></table>
</td><td><table cellpadding="0" cellspacing="0" class="codex"><tr><td class="codexLab"></td><td class="codexName"><tt>Check.xs (initialization code)</tt></td></tr><tr class="codex"><td class="codexLab"><tt class="codexLab">&nbsp;<br />&nbsp;<br />&nbsp;<br />&nbsp;<br />&nbsp;<br /></tt></td><td class="codexBody"><pre class="xdcscript"><span class="coMULTI">/* ======== instance$static$init ======== */</span>
<span class="kw1">function</span> instance$static$init<span class="br0">&#40;</span>obj, params<span class="br0">&#41;</span>
<span class="br0">&#123;</span>
    obj.count = <span class="nu0">0</span>;
<span class="br0">&#125;</span></pre></td></tr></table>
</td></tr></table>
<p>The <tt>doCheck()</tt> function, shown below, loops over all <i>statically defined</i> instances of the <tt>Check</tt> module looking for a counter that is non-zero.  
</p>
<div id="cl-1:1"></div><div id="cl-doCheck:1"></div><div id="cl-1:2"></div><div id="cl-doCheck:2"></div><table cellpadding="0" cellspacing="0" class="codex"><tr><td class="codexLab"></td><td class="codexName"><tt>Check.c (heap check code)</tt></td></tr><tr class="codex"><td class="codexLab"><tt class="codexLab">&nbsp;<br />&nbsp;<br />&nbsp;<br />&nbsp;<br />&nbsp;<br />&nbsp;<br />&nbsp;<br />&nbsp;<br />&nbsp;<br />&nbsp;<br />&nbsp;<br /><span class="codexLab">1</span><br /><span class="codexLab">2</span><br />&nbsp;<br />&nbsp;<br />&nbsp;<br />&nbsp;<br />&nbsp;<br /></tt></td><td class="codexBody"><pre class="c"><span class="re1">#include</span> <span class="re2">&lt;xdc/runtime/Error.h&gt;</span>
&nbsp;
<span class="coMULTI">/* ======== doCheck ======== */</span>
<span class="kw1">static</span> <span class="kw2">Void</span> doCheck<span class="br0">&#40;</span><span class="kw2">Void</span><span class="br0">&#41;</span>
<span class="br0">&#123;</span>
    <span class="kw2">Int</span> i;
    Error_Block eb;
&nbsp;
    Error_init<span class="br0">&#40;</span>&amp;eb<span class="br0">&#41;</span>;
&nbsp;
    <span class="coMULTI">/* loop over all static instances */</span>
    <span class="kw1">for</span> <span class="br0">&#40;</span>i = <span class="nu0">0</span>; i &lt; Check_Object_count<span class="br0">&#40;</span><span class="br0">&#41;</span>; i++<span class="br0">&#41;</span> <span class="br0">&#123;</span>
        Check_Object *obj = Check_Object_get<span class="br0">&#40;</span><span class="kw2">NULL</span>, i<span class="br0">&#41;</span>;
        <span class="kw1">if</span> <span class="br0">&#40;</span>obj-&gt;count&nbsp;!= <span class="nu0">0</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
            Error_raise<span class="br0">&#40;</span>&amp;eb, Check_E_memory, obj-&gt;count, <span class="br0">&#40;</span>IArg<span class="br0">&#41;</span>obj<span class="br0">&#41;</span>;
        <span class="br0">&#125;</span>
    <span class="br0">&#125;</span>
<span class="br0">&#125;</span></pre></td></tr></table>
<p></p>
<p>The methods used to loop over the instances, <tt>Check_Object_count()</tt> <a class="codexLink" href="#cl-doCheck:1"><span class="codexLink">1</span></a> and <tt>Check_Object_get()</tt> <a class="codexLink" href="#cl-doCheck:2"><span class="codexLink">2</span></a> are automatically generated from the <tt>Check</tt> module's specification.  For more information about these methods, see the <a href="../C_Language_Binding/C_Language_Binding.html" title="C Language Binding">C Language Binding</a> reference for <a href="../C_-_Object_count/C_-_Object_count.html" title="C - Object count">Object_count()</a> and <a href="../C_-_Object_get/C_-_Object_get.html" title="C - Object get">Object_get()</a>, respectively.
</p>
<p><div class="Notice"><p class="Notice">The <tt>doCheck</tt> function above does <i>not</i> look at any runtime created <tt>Check</tt> heap instances.  This can be added, of course, but since most heaps are created statically and we want to keep the example small, the implementation above does not check runtime created heaps.  For information about how to enumerate all runtime created instances of module, see <a href="../C_-_Object_first/C_-_Object_first.html" title="C - Object first">C - Object_first</a> and <a href="../C_-_Object_next/C_-_Object_next.html" title="C - Object next">C - Object_next</a>.</p></div></p> 
<p>To complete the C implementation it is, of course, necessary to define methods that allocate and free memory (as well as any other methods declared in the <tt>xdc.runtime.IHeap</tt> interface).  Shown below, these methods simply increment or decrement a counter and call the Check module's heap manager to to the "real" memory management.  The <tt>Check_Object_heap()</tt> method returns the heap instance configured for the <tt>Check</tt> module and, to support concurrent environments, the counter is modified atomically using the "system gate" via <tt><a href="../../cdoc/xdc/runtime/Gate.html#enter/.System" class="cdoc"><tt>Gate_enterSystem()</tt></a></tt>.
</p><p>Recall that the <tt>Check_Object_heap()</tt> method, like all <tt>*_Module_*</tt> methods, is declared in the headers automatically generated from the <tt>Check.xdc</tt> specification and defined in the <tt>*.c</tt> file generated by the configuration process.  See the <a href="../C_Language_Binding/C_Language_Binding.html" title="C Language Binding">C_Language_Binding</a> for a complete list of these automatically generated methods.
</p>
<table cellpadding="0" cellspacing="0" class="codex"><tr><td class="codexLab"></td><td class="codexName"><tt>Check.c (IHeap interface functions)</tt></td></tr><tr class="codex"><td class="codexLab"><tt class="codexLab">&nbsp;<br />&nbsp;<br />&nbsp;<br />&nbsp;<br />&nbsp;<br />&nbsp;<br />&nbsp;<br />&nbsp;<br />&nbsp;<br />&nbsp;<br />&nbsp;<br />&nbsp;<br />&nbsp;<br />&nbsp;<br />&nbsp;<br />&nbsp;<br />&nbsp;<br />&nbsp;<br />&nbsp;<br />&nbsp;<br />&nbsp;<br />&nbsp;<br />&nbsp;<br />&nbsp;<br />&nbsp;<br />&nbsp;<br />&nbsp;<br />&nbsp;<br />&nbsp;<br />&nbsp;<br />&nbsp;<br />&nbsp;<br />&nbsp;<br />&nbsp;<br />&nbsp;<br />&nbsp;<br />&nbsp;<br />&nbsp;<br />&nbsp;<br />&nbsp;<br />&nbsp;<br /></tt></td><td class="codexBody"><pre class="c"><span class="re1">#include</span> <span class="re2">&lt;xdc/runtime/Gate.h&gt;</span>
<span class="re1">#include</span> <span class="re2">&lt;xdc/runtime/Memory.h&gt;</span>
&nbsp;
<span class="coMULTI">/* ======== Check_alloc ======== */</span>
Ptr Check_alloc<span class="br0">&#40;</span>Check_Object *obj, <span class="kw2">SizeT</span> size, 
    <span class="kw2">SizeT</span> align, Error_Block *eb<span class="br0">&#41;</span>
<span class="br0">&#123;</span>
    Ptr result = Memory_alloc<span class="br0">&#40;</span>Check_Object_heap<span class="br0">&#40;</span><span class="br0">&#41;</span>, size, align, eb<span class="br0">&#41;</span>;
&nbsp;
    <span class="kw1">if</span> <span class="br0">&#40;</span>result&nbsp;!= <span class="kw2">NULL</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
        <span class="coMULTI">/* atomically increment count */</span>
        IArg key = Gate_enterSystem<span class="br0">&#40;</span><span class="br0">&#41;</span>; 
        obj-&gt;count++;
        Gate_leaveSystem<span class="br0">&#40;</span>key<span class="br0">&#41;</span>;
    <span class="br0">&#125;</span>
&nbsp;
    <span class="kw1">return</span> <span class="br0">&#40;</span>result<span class="br0">&#41;</span>;
<span class="br0">&#125;</span>
&nbsp;
<span class="coMULTI">/* ======== Check_free ======== */</span>
<span class="kw2">Void</span> Check_free<span class="br0">&#40;</span>Check_Object *obj, Ptr block, <span class="kw2">SizeT</span> size<span class="br0">&#41;</span>
<span class="br0">&#123;</span>
    <span class="coMULTI">/* atomically decrement count */</span>
    IArg key = Gate_enterSystem<span class="br0">&#40;</span><span class="br0">&#41;</span>;
    obj-&gt;count--;
    Gate_leaveSystem<span class="br0">&#40;</span>key<span class="br0">&#41;</span>;
&nbsp;
    Memory_free<span class="br0">&#40;</span>Check_Object_heap<span class="br0">&#40;</span><span class="br0">&#41;</span>, block, size<span class="br0">&#41;</span>;
<span class="br0">&#125;</span>
&nbsp;
<span class="coMULTI">/* ======== Check_isBlocking ======== */</span>
<span class="kw2">Bool</span> Check_isBlocking<span class="br0">&#40;</span>Check_Object *obj<span class="br0">&#41;</span>
<span class="br0">&#123;</span>
    <span class="kw1">return</span> <span class="br0">&#40;</span>Memory_query<span class="br0">&#40;</span>Check_Object_heap<span class="br0">&#40;</span><span class="br0">&#41;</span>, Memory_Q_BLOCKING<span class="br0">&#41;</span><span class="br0">&#41;</span>;
<span class="br0">&#125;</span>
&nbsp;
<span class="coMULTI">/* ======== Check_getStats ======== */</span>
<span class="kw2">Void</span> Check_getStats<span class="br0">&#40;</span>Check_Object *obj, Memory_Stats *stats<span class="br0">&#41;</span>
<span class="br0">&#123;</span>
    Memory_getStats<span class="br0">&#40;</span>Check_Object_heap<span class="br0">&#40;</span><span class="br0">&#41;</span>, stats<span class="br0">&#41;</span>;
<span class="br0">&#125;</span></pre></td></tr></table>
<p></p>
<p>Finally we need to add a meta-domain function to <tt>Check.xs</tt>: <tt><a href="../XDCscript_-_Module-Body.module%24use/XDCscript_-_Module-Body.module%24use.html" title="XDCscript - Module-Body.module$use">module$use</a></tt>.  
</p>
<table cellpadding="0" cellspacing="0" class="codex"><tr><td class="codexLab"></td><td class="codexName"><tt>Check.xs (implementation dependencies)</tt></td></tr><tr class="codex"><td class="codexLab"><tt class="codexLab">&nbsp;<br />&nbsp;<br />&nbsp;<br />&nbsp;<br />&nbsp;<br />&nbsp;<br />&nbsp;<br />&nbsp;<br /></tt></td><td class="codexBody"><pre class="xdcscript"><span class="coMULTI">/* ======== module$use======== */</span>
<span class="kw1">function</span> module$use<span class="br0">&#40;</span><span class="br0">&#41;</span>
<span class="br0">&#123;</span>
    <span class="re1">xdc.useModule</span><span class="br0">&#40;</span><span class="st0">&quot;xdc.runtime.System&quot;</span><span class="br0">&#41;</span>;
    <span class="re1">xdc.useModule</span><span class="br0">&#40;</span><span class="st0">&quot;xdc.runtime.Error&quot;</span><span class="br0">&#41;</span>;
    <span class="re1">xdc.useModule</span><span class="br0">&#40;</span><span class="st0">&quot;xdc.runtime.Gate&quot;</span><span class="br0">&#41;</span>;
    <span class="re1">xdc.useModule</span><span class="br0">&#40;</span><span class="st0">&quot;xdc.runtime.Memory&quot;</span><span class="br0">&#41;</span>;
<span class="br0">&#125;</span></pre></td></tr></table>
<p>The <tt>module$use</tt> function ensures that all modules used in the implementation of <tt>Check</tt> are included in both the configuration process and in the link of the application using <tt>Check</tt>.  By adding these statements, the user of <tt>Check</tt> does not need to add <tt>xdc.useModule</tt> statements their configuration script for modules that are not <i>directly</i> referenced by their application.  After all, the implementation of <tt>Check</tt> may change to require other modules and we don't want the client of <tt>Check</tt> to have to change <i>anything</i> to use this new version.
</p>
<a name="The_Package_Files"></a><h3> <span class="mw-headline">The Package Files</span></h3>
<p>Since all modules must live in a package we also need to create a two other files:
</p>
<ol><li><tt>package.xdc</tt> - a file that define the package's name and identifies the modules it contains, and
</li><li><tt>package.bld</tt> - a file that specifies which targets should be used to build the sources contained in this package.
</li></ol>
<table>

<tr valign="top">
<td><table cellpadding="0" cellspacing="0" class="codex"><tr><td class="codexLab"></td><td class="codexName"><tt>package.xdc</tt></td></tr><tr class="codex"><td class="codexLab"><tt class="codexLab">&nbsp;<br />&nbsp;<br />&nbsp;<br /></tt></td><td class="codexBody"><pre class="xdcspec"><span class="kw1">package</span> examples.runtime.heap <span class="br0">&#123;</span> 
    <span class="kw1">module</span> Check; 
<span class="br0">&#125;</span></pre></td></tr></table>
</td><td><table cellpadding="0" cellspacing="0" class="codex"><tr><td class="codexLab"></td><td class="codexName"><tt>package.bld</tt></td></tr><tr class="codex"><td class="codexLab"><tt class="codexLab">&nbsp;<br />&nbsp;<br />&nbsp;<br />&nbsp;<br />&nbsp;<br />&nbsp;<br /></tt></td><td class="codexBody"><pre class="xdcscript"><span class="kw1">for</span> <span class="br0">&#40;</span><span class="kw1">var</span> i = <span class="nu0">0</span>; i &lt; Build.targets.length; i++<span class="br0">&#41;</span> <span class="br0">&#123;</span>
    <span class="kw1">var</span> targ = Build.targets<span class="br0">&#91;</span>i<span class="br0">&#93;</span>;
&nbsp;
    <span class="kw1">var</span> lib = Pkg.addLibrary<span class="br0">&#40;</span><span class="st0">&quot;lib/&quot;</span> + Pkg.name, targ<span class="br0">&#41;</span>;
    lib.addObjects<span class="br0">&#40;</span><span class="br0">&#91;</span><span class="st0">&quot;Check.c&quot;</span><span class="br0">&#93;</span><span class="br0">&#41;</span>;
<span class="br0">&#125;</span></pre></td></tr></table>
</td></tr></table>
<p>The <tt>package.xdc</tt> file is largely self explanatory; it defines the name of the package <tt>examples.runtime.heap</tt> and it specifies the modules contained in the package, <tt>Check</tt>.  
</p><p>The <tt>package.bld</tt> file, on the other hand, requires some explanation.  The existence of <tt>package.bld</tt> indicates that the package is (re)buildable - unless the end-user is expected to build the package, deployed packages omit this file.  The contents of this <tt>package.bld</tt> file indicate that the package contains a library in the <tt>lib/</tt> sub-directory containing the compiled version of <tt>Check.c</tt> for every <a href="../Glossary/Glossary.html#Target" title="Glossary">target</a> supported by the producer's build environment.  Remarkably, this <tt>package.bld</tt> file is sufficient to compile <tt>Check.c</tt> for every target, archive it into a library, and create a <a href="../Glossary/Glossary.html#Release" title="Glossary">binary release</a> of this package that supports <i>all</i> targets supported by the producer's build environment.
</p>
<a name="Summary_and_Extensions"></a><h2> <span class="mw-headline">Summary and Extensions</span></h2>
<p>This example illustrated how to create and deploy a new <tt>IHeap</tt> memory manager.  Along the way, it also illustrated several key concepts:
</p>
<ul><li> how a module can scan all of its statically created instances; <tt>Check_Object_count()</tt> and <tt>Check_Object_get()</tt>.
</li><li> how a module can perform module-specific initialization before <tt>main()</tt>; <tt>@ModuleStartup</tt> and <tt>Check_Module_startup()</tt>
</li><li> how to "stack" <tt>IHeap</tt> memory managers to add functionality to an existing memory manager <i>without changing (or re-compiling) the application's sources</i>.
</li></ul>
<p>Although simplistic, it is clear that this example can be extended to provide far more robust memory checking.  Possible extensions include 
</p>
<ul><li> wrapping each allocation with a leading and a trailing "cookie" which can be checked on each free operation to detect buffer over/under flow problems;
</li><li> tagging each allocation with a "thread id" so that when a leak is detected it's possible to identify the culprit and even recover the memory;
</li><li> add methods to <tt>Check</tt> that can be called by the application to set thread-specific limits on the total outstanding memory allocated by each thread; and
</li><li> add methods to <tt>Check</tt> that direct it to return <tt>NULL</tt> after a specific number of allocations allowing one to reliably test the application's ability to handle out-of-memory faults.
</li></ul>
<table width="100%"><tr><td class="lights"><img src="../common/extensions/rtsc/images/yellow_light.png" /></td><td class="offline">[<a href="/mediawiki-tip/index.php?title=Extending xdc.runtime Memory/Example 1&amp;printable=yes" title="just this page in black-and-white, ready for printing in landscape orientation">printable version</a>]&nbsp;&nbsp;</td><td class="offlineDate">offline version generated on 02-Oct-2009 22:10 UTC</td><td class="arrows"><a href="Extending_xdc.runtime_Memory.html#TOC" title="Extending xdc.runtime Memory"><img src="../common/extensions/rtsc/images/Arrow_up.png" /></a></td></tr></table><div id=copyInfo>Copyright &#169; 2008 The Eclipse Foundation. All Rights Reserved</div>
<!-- 
Pre-expand include size: 1570 bytes
Post-expand include size: 776 bytes
Template argument size: 104 bytes
Maximum: 2097152 bytes
-->

			<div class="printfooter">
Retrieved from "<a href="http://rtsc.eclipse.org/docs-tip/Special:Offline">http://rtsc.eclipse.org/docs-tip/Special:Offline</a>"</div>
						<!-- end content -->
			<div class="visualClear"></div>
		</div>
	</div>
		</div>
		<div id="column-one">
	<div id="p-cactions" class="portlet">
		<h5>Views</h5>
		<div class="pBody">
			<ul>
					 <li id="ca-nstab-special" class="selected"><a href="../Special:Offline/Special:Offline__Extending_xdc.runtime_Memory.html" title="This is a special page, you can't edit the page itself">Special</a></li>
				</ul>
		</div>
	</div>
	<div class="portlet" id="p-personal">
		<h5>Personal tools</h5>
		<div class="pBody">
			<ul>
				<li id="pt-login"><a href="mediawiki-tip/index.php?title=Special:Userlogin&amp;returnto=Special:Offline" title="You are encouraged to log in, it is not mandatory however. [o]" accesskey="o">Log in / create account</a></li>
			</ul>
		</div>
	</div>
	<div class="portlet" id="p-logo">
		<a style="background-image: url(../common/extensions/rtsc/images/logo.png);" href="/docs-tip/Main_Page" title="Visit the Main Page [z]" accesskey="z"></a>
	</div>
	<script type="text/javascript"> if (window.isMSIE55) fixalpha(); </script>
		<div class='portlet' id='p-navigation'>
		<h5>Navigation</h5>
		<div class='pBody'>
			<ul>
				<li id="n-RTSC-pedia-home"><a href="../Main_Page/Main_Page.html">RTSC-pedia home</a></li>
				<li id="n-RTSC-project-home"><a href="http://rtsc.eclipse.org ">RTSC project home</a></li>
				<li id="n-News-.26-support"><a href="http://www.eclipse.org/newsportal/thread.php?group=eclipse.dsdp.rtsc">News &amp; support</a></li>
				<li id="n-Help"><a href="../Help:Contents/Help:Contents.html">Help</a></li>
			</ul>
		</div>
	</div>
		<div class='portlet' id='p-binders'>
		<h5>binders</h5>
		<div class='pBody'>
			<ul>
				<li id="n-General-Information"><a href="../General_Information/General_Information.html">General Information</a></li>
				<li id="n-RTSC-Programming"><a href="../RTSC_Programming/RTSC_Programming.html">RTSC Programming</a></li>
				<li id="n-User.27s-Guide"><a href="../XDCtools_User%27s_Guide/XDCtools_User%27s_Guide.html">User's Guide</a></li>
				<li id="n-Reference-Manual"><a href="../XDCtools_Reference_Manual/XDCtools_Reference_Manual.html">Reference Manual</a></li>
			</ul>
		</div>
	</div>
		<div class='portlet' id='p-package_reference'>
		<h5>package reference</h5>
		<div class='pBody'>
			<ul>
				<li id="n-XDCtools-packages"><a href="http://rtsc.eclipse.org/cdoc-tip/index.html ">XDCtools packages</a></li>
			</ul>
		</div>
	</div>
		<div class='portlet' id='p-lists'>
		<h5>lists</h5>
		<div class='pBody'>
			<ul>
				<li id="n-Master-doc-map"><a href="../Special:DocMap/Special:DocMap__Main_Page.html">Master doc-map</a></li>
				<li id="n-Category-query"><a href="../Special:Cats/Special:Cats.html">Category query</a></li>
				<li id="n-Redirected-pages"><a href="../Special:Listredirects/Special:Listredirects.html">Redirected pages</a></li>
			</ul>
		</div>
	</div>
		<div class='portlet' id='p-tools'>
		<h5>tools</h5>
		<div class='pBody'>
			<ul>
				<li id="n-Find.2BReplace-.28grep.29"><a href="../Special:Grep/Special:Grep.html">Find+Replace (grep)</a></li>
				<li id="n-RSS-feed"><a href="http://rtsc.eclipse.orgmediawiki-tip/index.php?title=Special:Recentchanges&amp;feed=rss ">RSS feed</a></li>
			</ul>
		</div>
	</div>
		<div id="p-search" class="portlet">
		<h5><label for="searchInput">Search</label></h5>
		<div id="searchBody" class="pBody">
			<form action="/docs-tip/Special:Search" id="searchform"><div>
				<input id="searchInput" name="search" type="text" title="Search RTSC-Pedia [f]" accesskey="f" value="" />
				<input type='submit' name="go" class="searchButton" id="searchGoButton"	value="Go" />&nbsp;
				<input type='submit' name="fulltext" class="searchButton" id="mw-searchButton" value="Search" />
			</div></form>
		</div>
	</div>
	<div class="portlet" id="p-tb">
		<h5>more tools</h5>
		<div class="pBody">
			<ul>
<li id="t-upload"><a href="../Special:Upload/Special:Upload.html" title="Upload images or media files [u]" accesskey="u">Upload file</a></li>
<li id="t-specialpages"><a href="../Special:Specialpages/Special:Specialpages.html" title="List of all special pages [q]" accesskey="q">Special pages</a></li>
			</ul>
		</div>
	</div>
		</div><!-- end of the left (by default at least) column -->
			<div class="visualClear"></div>
			<div id="footer">
				<div id="f-poweredbyico"><a href="http://www.mediawiki.org/"><img src="../common/skins/common/images/poweredby_mediawiki_88x31.png" alt="Powered by MediaWiki" /></a></div>
			<ul id="f-list">
				<li id="privacy"><a href="../RTSC-Pedia:Privacy_policy/RTSC-Pedia:Privacy_policy.html" title="RTSC-Pedia:Privacy policy">Privacy policy</a></li>
				<li id="about"><a href="../RTSC-Pedia:About/RTSC-Pedia:About.html" title="RTSC-Pedia:About">About RTSC-Pedia</a></li>
				<li id="disclaimer"><a href="../RTSC-Pedia:General_disclaimer/RTSC-Pedia:General_disclaimer.html" title="RTSC-Pedia:General disclaimer">Disclaimers</a></li>
			</ul>
		</div>
		
	
		<script type="text/javascript">if (window.runOnloadHook) runOnloadHook();</script>
</div>
<!-- Served in 0.218 secs. --></body></html>
